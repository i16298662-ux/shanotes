import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext
import hashlib
import base64
from cryptography.fernet import Fernet, InvalidToken
import os

class SHANotesApp:
    def __init__(self, root):
        self.root = root
        self.root.title("SHA-Notes (Secure Encryption)")
        self.root.geometry("600x500")
        
        # --- UI Layout ---
        
        # Label Judul
        self.label_title = tk.Label(root, text="SHA-Notes", font=("Arial", 16, "bold"))
        self.label_title.pack(pady=10)

        # Input Password Frame
        self.frame_auth = tk.Frame(root)
        self.frame_auth.pack(pady=5)
        
        tk.Label(self.frame_auth, text="Password Kunci:").pack(side=tk.LEFT, padx=5)
        self.entry_password = tk.Entry(self.frame_auth, show="*", width=30)
        self.entry_password.pack(side=tk.LEFT, padx=5)

        # Area Teks Utama
        self.text_area = scrolledtext.ScrolledText(root, width=70, height=20)
        self.text_area.pack(pady=10, padx=10)

        # Tombol Aksi
        self.frame_buttons = tk.Frame(root)
        self.frame_buttons.pack(pady=10)

        self.btn_open = tk.Button(self.frame_buttons, text="Buka File Terenkripsi", command=self.buka_file, bg="#ddd")
        self.btn_open.pack(side=tk.LEFT, padx=10)

        self.btn_save = tk.Button(self.frame_buttons, text="Simpan & Enkripsi", command=self.simpan_file, bg="#4CAF50", fg="white")
        self.btn_save.pack(side=tk.LEFT, padx=10)
        
        self.btn_clear = tk.Button(self.frame_buttons, text="Bersihkan", command=self.bersihkan, bg="#f44336", fg="white")
        self.btn_clear.pack(side=tk.LEFT, padx=10)

        # Status Bar
        self.status = tk.Label(root, text="Siap.", bd=1, relief=tk.SUNKEN, anchor=tk.W)
        self.status.pack(side=tk.BOTTOM, fill=tk.X)

    def generate_key_from_password(self, password):
        """
        Inti Keamanan:
        Menggunakan SHA-512 untuk mengubah password text menjadi 
        kunci 32-byte yang valid untuk Enkripsi Fernet (AES).
        """
        if not password:
            return None
        
        # 1. Hashing password dengan SHA-512
        digest = hashlib.sha512(password.encode('utf-8')).digest()
        
        # 2. Fernet membutuhkan kunci 32 byte yang di-encode base64.
        # SHA-512 menghasilkan 64 byte, kita ambil 32 byte pertama saja.
        key_bytes = digest[:32]
        
        # 3. Encode ke format URL-safe Base64 agar bisa dipakai Fernet
        key = base64.urlsafe_b64encode(key_bytes)
        return key

    def simpan_file(self):
        password = self.entry_password.get()
        if not password:
            messagebox.showwarning("Peringatan", "Masukkan password untuk mengenkripsi!")
            return

        isi_catatan = self.text_area.get("1.0", tk.END).strip()
        if not isi_catatan:
            messagebox.showwarning("Peringatan", "Catatan kosong, tidak ada yang disimpan.")
            return

        # Generate Kunci
        kunci = self.generate_key_from_password(password)
        f = Fernet(kunci)

        # Proses Enkripsi
        try:
            data_terenkripsi = f.encrypt(isi_catatan.encode('utf-8'))
            
            # Dialog Simpan File
            file_path = filedialog.asksaveasfilename(
                defaultextension=".sha",
                filetypes=[("SHA Notes Encrypted", "*.sha"), ("All Files", "*.*")]
            )
            
            if file_path:
                with open(file_path, "wb") as file:
                    file.write(data_terenkripsi)
                self.status.config(text=f"Berhasil disimpan: {os.path.basename(file_path)}")
                messagebox.showinfo("Sukses", "File berhasil disimpan dan dienkripsi!")
        except Exception as e:
            messagebox.showerror("Error", f"Gagal menyimpan: {str(e)}")

    def buka_file(self):
        password = self.entry_password.get()
        if not password:
            messagebox.showwarning("Peringatan", "Masukkan password untuk mendekripsi file!")
            return

        file_path = filedialog.askopenfilename(
            filetypes=[("SHA Notes Encrypted", "*.sha"), ("All Files", "*.*")]
        )

        if not file_path:
            return

        # Generate Kunci dari password saat ini
        kunci = self.generate_key_from_password(password)
        f = Fernet(kunci)

        try:
            with open(file_path, "rb") as file:
                data_terenkripsi = file.read()
            
            # Proses Dekripsi
            data_asli = f.decrypt(data_terenkripsi).decode('utf-8')
            
            # Tampilkan ke layar
            self.text_area.delete("1.0", tk.END)
            self.text_area.insert("1.0", data_asli)
            self.status.config(text=f"Berhasil membuka: {os.path.basename(file_path)}")
            
        except InvalidToken:
            messagebox.showerror("Gagal", "Password Salah! File tidak dapat didekripsi.")
        except Exception as e:
            messagebox.showerror("Error", f"Terjadi kesalahan: {str(e)}")

    def bersihkan(self):
        self.text_area.delete("1.0", tk.END)
        self.entry_password.delete(0, tk.END)
        self.status.config(text="Siap.")

if __name__ == "__main__":
    root = tk.Tk()
    app = SHANotesApp(root)
    root.mainloop()
